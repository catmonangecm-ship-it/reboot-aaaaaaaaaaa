<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Trading IA Pro - R√©el</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .ai-thinking {
            background: linear-gradient(90deg, #8b5cf6, #ec4899, #8b5cf6);
            background-size: 200% 100%;
            animation: gradient 2s ease infinite;
        }
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
    </style>
</head>
<body class="text-white p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-purple-400 bg-clip-text text-transparent">
                    ü§ñ Bot Trading IA Pro - R√âEL
                </h1>
                <p class="text-gray-400 mt-2">PancakeSwap (BSC) & Binance Spot ‚Ä¢ Trading Automatis√© 24/7</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="connectWallet()" id="connectBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600">
                    <span>üëõ</span>
                    <span id="walletText">MetaMask</span>
                </button>
                <button onclick="togglePrivateKeyModal()" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600">
                    <span>üîë</span>
                    <span>Cl√© Priv√©e</span>
                </button>
            </div>
        </div>

        <!-- Private Key Modal -->
        <div id="privateKeyModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-slate-800 border-2 border-purple-500 rounded-2xl p-6 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-purple-400">üîë Connexion par Cl√© Priv√©e</h3>
                    <button onclick="togglePrivateKeyModal()" class="text-gray-400 hover:text-white text-2xl">√ó</button>
                </div>
                
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
                    <p class="text-yellow-400 text-sm flex items-start gap-2">
                        <span>‚ö†Ô∏è</span>
                        <span>Ne partagez jamais votre cl√© priv√©e. Assurez-vous d'√™tre seul et sur un appareil s√©curis√©.</span>
                    </p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Cl√© priv√©e (avec ou sans 0x)</label>
                    <input type="password" id="privateKeyInput" placeholder="0x..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-400 font-mono text-sm">
                </div>
                
                <button onclick="connectWithPrivateKey()" class="w-full px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-lg font-semibold transition-all">
                    Se connecter
                </button>
            </div>
        </div>

        <!-- Binance API Modal -->
        <div id="binanceModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-slate-800 border-2 border-yellow-500 rounded-2xl p-6 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-yellow-400">üü° Connexion Binance API</h3>
                    <button onclick="toggleBinanceModal()" class="text-gray-400 hover:text-white text-2xl">√ó</button>
                </div>
                
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4">
                    <p class="text-blue-400 text-sm">
                        üí° <strong>Obtenir vos cl√©s API :</strong><br>
                        1. Binance.com ‚Üí Profil ‚Üí API Management<br>
                        2. Cr√©er une API Key<br>
                        3. Activez "Enable Spot & Margin Trading"
                    </p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">API Key</label>
                    <input type="text" id="binanceApiKeyInput" placeholder="Votre API Key" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 font-mono text-sm">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Secret Key</label>
                    <input type="password" id="binanceSecretKeyInput" placeholder="Votre Secret Key" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 font-mono text-sm">
                </div>
                
                <button onclick="connectBinanceFromModal()" class="w-full px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 rounded-lg font-semibold transition-all">
                    Connecter Binance
                </button>
            </div>
        </div>

        <!-- AI Status -->
        <div id="aiStatus" class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 border-2 border-purple-500 rounded-xl p-6 mb-6 hidden">
            <div class="flex items-center gap-4 mb-4">
                <div class="relative">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-3xl">
                        ü§ñ
                    </div>
                    <div id="aiIndicator" class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full animate-pulse"></div>
                </div>
                <div>
                    <h3 class="text-xl font-bold">Assistant IA Claude</h3>
                    <p class="text-sm text-gray-400">Analyse en temps r√©el ‚Ä¢ Trading automatique</p>
                </div>
            </div>
            
            <div id="aiThinking" class="bg-slate-700/50 rounded-lg p-4 mb-4 hidden">
                <div class="flex items-center gap-3">
                    <div class="ai-thinking w-2 h-2 rounded-full"></div>
                    <p class="text-sm text-purple-300 italic">L'IA analyse les donn√©es du march√©...</p>
                </div>
            </div>
            
            <div id="aiRecommendation" class="bg-slate-700/50 rounded-lg p-4 hidden">
                <p class="text-purple-300 font-bold mb-2">üí° Recommandation IA</p>
                <p id="aiRecommendationText" class="text-sm text-gray-300"></p>
                <div class="mt-3 flex gap-2">
                    <span id="aiConfidence" class="px-3 py-1 bg-purple-500/30 rounded-full text-xs font-semibold"></span>
                    <span id="aiAction" class="px-3 py-1 rounded-full text-xs font-semibold"></span>
                </div>
            </div>
        </div>

        <!-- Crypto Selector -->
        <div id="cryptoSelector" class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6 mb-6 hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Cryptomonnaie</label>
                    <select id="cryptoSelect" onchange="changeCrypto()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-400 text-lg font-semibold cursor-pointer">
                        <option value="BTCUSDT">BTC - Bitcoin üíé</option>
                        <option value="ETHUSDT">ETH - Ethereum üíé</option>
                        <option value="BNBUSDT">BNB - Binance Coin üíé</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mode de Trading</label>
                    <select id="tradingMode" onchange="changeTradingMode()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-400 text-lg font-semibold cursor-pointer">
                        <option value="simulation">üéÆ Simulation</option>
                        <option value="real-binance">üü° R√©el Binance</option>
                        <option value="real-pancake">üíé R√©el PancakeSwap</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-2">Connexion rapide</label>
                    <button onclick="toggleBinanceModal()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 rounded-lg px-4 py-3 font-semibold transition-all">
                        üü° Binance API
                    </button>
                </div>
            </div>
        </div>

        <!-- Capital Section -->
        <div id="capitalSection" class="bg-gradient-to-r from-purple-400/20 to-pink-500/20 border-2 border-purple-400 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4">üéØ Capital de trading</h3>
            <div class="flex gap-4 mb-3">
                <input type="number" id="capitalInput" placeholder="Ex: 100" step="10" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-purple-400">
                <button onclick="setCapital()" class="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-lg font-semibold transition-all">
                    Valider
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="statsCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 hidden">
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Capital</p>
                <p class="text-xl font-bold mt-1 text-purple-400">$<span id="capitalDisplay">0</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Prix <span id="cryptoName">BTC</span></p>
                <p class="text-xl font-bold mt-1">$<span id="currentPrice">...</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Profit IA</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="profitDisplay">0.00</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Pr√©cision IA</p>
                <p class="text-xl font-bold mt-1 text-purple-400"><span id="aiAccuracy">0</span>%</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Chart -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">üìà Analyse IA</h2>
                        <div class="text-sm text-gray-400">
                            <span id="chartCrypto">BTC</span>/USDT
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="tradingChart"></canvas>
                    </div>
                </div>

                <!-- Trade History -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">ü§ñ Trades IA</h2>
                        <button onclick="toggleBot()" id="toggleBotBtn" disabled class="flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-gray-600 cursor-not-allowed">
                            <span id="botIcon">‚ñ∂Ô∏è</span>
                            <span id="botText">D√©marrer IA</span>
                        </button>
                    </div>
                    <div id="tradesContainer">
                        <div class="text-center py-8 text-gray-400">
                            <span class="text-4xl">ü§ñ</span>
                            <p>L'IA attend vos instructions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Param√®tres IA</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Agressivit√© IA</label>
                        <select id="aiAggression" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-400">
                            <option value="conservative">üê¢ Conservateur (S√ªr)</option>
                            <option value="moderate" selected>‚öñÔ∏è Mod√©r√© (√âquilibr√©)</option>
                            <option value="aggressive">üöÄ Agressif (Risqu√©)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">% par trade</label>
                        <input type="number" id="tradePercent" value="10" min="1" max="100" onchange="updateTradeAmount()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-400">
                        <p class="text-xs text-gray-400 mt-1">Montant: $<span id="tradeAmount">0</span></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Intervalle d'analyse</label>
                        <select id="aiInterval" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-400">
                            <option value="5000">‚ö° Rapide (5s)</option>
                            <option value="15000" selected>‚öñÔ∏è Normal (15s)</option>
                            <option value="30000">üê¢ Lent (30s)</option>
                        </select>
                    </div>

                    <div class="bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/30 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-semibold text-green-400">üîã Mode Veille</label>
                            <div class="relative">
                                <input type="checkbox" id="wakeLockToggle" onchange="toggleWakeLock()" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400">Trading 24/7 sans interruption</p>
                        <p id="wakeLockStatus" class="text-xs text-gray-400 mt-2">Status: <span class="text-red-400">D√©sactiv√©</span></p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-purple-400/10 border border-purple-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-purple-400">ü§ñ</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-purple-400">Statut</p>
                            <p>Wallet: <span id="walletStatus">üî¥ Non connect√©</span></p>
                            <p>Binance: <span id="binanceStatus">üî¥ Non connect√©</span></p>
                            <p>Position: <span id="positionStatus">‚ö™ Aucune</span></p>
                            <p>Trades: <span id="aiTrades">0</span></p>
                            <p>R√©ussite: <span id="successRate">0%</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-orange-400/10 border border-orange-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-orange-400">‚ö°</span>
                        <div class="text-xs text-gray-300">
                            <p class="font-semibold text-orange-400">Plateformes</p>
                            <p class="mt-2">üü° <strong>Binance Spot</strong></p>
                            <p>‚Ä¢ Frais: 0.1% par trade</p>
                            <p>‚Ä¢ Vitesse: 1-2 secondes</p>
                            <p>‚Ä¢ Recommand√© pour bot 24/7</p>
                            <p class="mt-2">üíé <strong>PancakeSwap</strong></p>
                            <p>‚Ä¢ Frais: 0.3% + gas BNB</p>
                            <p>‚Ä¢ Vitesse: 3-5 secondes</p>
                            <p>‚Ä¢ D√©centralis√© (BSC)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
        const USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955';
        const WBNB_CONTRACT = '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c';
        const BSC_RPC = 'https://bsc-dataseed1.binance.org';
        
        const TOKEN_ADDRESSES = {
            'BTCUSDT': '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
            'ETHUSDT': '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
            'BNBUSDT': '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c'
        };

        const ROUTER_ABI = [
            'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)',
            'function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)'
        ];

        const ERC20_ABI = [
            'function approve(address spender, uint256 amount) public returns (bool)',
            'function allowance(address owner, address spender) public view returns (uint256)',
            'function balanceOf(address account) public view returns (uint256)'
        ];

        let state = {
            account: null,
            isConnected: false,
            selectedCrypto: 'BTCUSDT',
            currentPrice: null,
            priceHistory: [],
            tradingCapital: 0,
            capitalSet: false,
            tradingMode: 'simulation',
            botRunning: false,
            trades: [],
            portfolio: { profit: 0 },
            currentPosition: null,
            lastBuyPrice: 0,
            positionAmount: 0,
            aiStats: { totalTrades: 0, successfulTrades: 0, accuracy: 0 },
            provider: null,
            wallet: null,
            connectionType: null,
            realTrading: { pendingTx: null },
            binance: { apiKey: null, secretKey: null, connected: false }
        };

        let ws = null, botInterval = null, tradingChart = null, wakeLock = null, keepAliveInterval = null;

        window.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ Bot IA charg√©');
            initChart();
            connectWebSocket();
            initVisibilityListener();
            initKeepAlive();
        });

        function togglePrivateKeyModal() {
            document.getElementById('privateKeyModal').classList.toggle('hidden');
        }

        function toggleBinanceModal() {
            document.getElementById('binanceModal').classList.toggle('hidden');
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert('‚ùå MetaMask requis');
                return;
            }
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                state.account = accounts[0];
                state.provider = new ethers.providers.Web3Provider(window.ethereum);
                state.isConnected = true;
                state.connectionType = 'metamask';
                console.log('‚úÖ Wallet:', state.account);
                updateUI();
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        async function connectWithPrivateKey() {
            const privateKey = document.getElementById('privateKeyInput').value.trim();
            if (!privateKey) {
                alert('‚ùå Veuillez entrer une cl√© priv√©e');
                return;
            }
            try {
                let pk = privateKey.startsWith('0x') ? privateKey : '0x' + privateKey;
                if (pk.length !== 66) {
                    alert('‚ùå Cl√© priv√©e invalide (64 caract√®res sans 0x)');
                    return;
                }
                state.provider = new ethers.providers.JsonRpcProvider(BSC_RPC);
                state.wallet = new ethers.Wallet(pk, state.provider);
                state.account = state.wallet.address;
                state.isConnected = true;
                state.connectionType = 'privatekey';
                togglePrivateKeyModal();
                updateUI();
                alert('‚úÖ Connexion r√©ussie!\nAdresse: ' + state.account.slice(0, 6) + '...' + state.account.slice(-4));
            } catch (error) {
                alert('‚ùå Erreur: Cl√© priv√©e invalide\n\n' + error.message);
            }
        }

        async function connectBinanceFromModal() {
            const apiKey = document.getElementById('binanceApiKeyInput').value.trim();
            const secretKey = document.getElementById('binanceSecretKeyInput').value.trim();
            if (!apiKey || !secretKey) {
                alert('‚ùå Veuillez entrer vos cl√©s API');
                return;
            }
            try {
                const timestamp = Date.now();
                const queryString = `timestamp=${timestamp}`;
                const signature = await createBinanceSignature(secretKey, queryString);
                const response = await fetch(`https://api.binance.com/api/v3/account?${queryString}&signature=${signature}`, {
                    headers: { 'X-MBX-APIKEY': apiKey }
                });
                if (response.ok) {
                    const data = await response.json();
                    state.binance.apiKey = apiKey;
                    state.binance.secretKey = secretKey;
                    state.binance.connected = true;
                    document.getElementById('binanceStatus').innerHTML = 'üü¢ Connect√©';
                    toggleBinanceModal();
                    alert(`‚úÖ Binance API connect√©e!\n\nCompte: ${data.accountType}`);
                } else {
                    const error = await response.json();
                    throw new Error(error.msg || 'Erreur API');
                }
            } catch (error) {
                alert(`‚ùå Erreur Binance:\n\n${error.message}`);
            }
        }

        async function createBinanceSignature(secret, queryString) {
            const encoder = new TextEncoder();
            const data = encoder.encode(queryString);
            const key = encoder.encode(secret);
            const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
            const signature = await crypto.subtle.sign('HMAC', cryptoKey, data);
            return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function updateUI() {
            if (state.isConnected) {
                const badge = state.connectionType === 'privatekey' ? 'üîë' : 'üëõ';
                document.getElementById('connectBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
                document.getElementById('walletText').textContent = `${badge} ${state.account.slice(0, 6)}...${state.account.slice(-4)}`;
                document.getElementById('walletStatus').innerHTML = `üü¢ ${state.connectionType === 'privatekey' ? 'Cl√© priv√©e' : 'MetaMask'}`;
                document.getElementById('aiStatus').classList.remove('hidden');
                document.getElementById('cryptoSelector').classList.remove('hidden');
                document.getElementById('capitalSection').classList.remove('hidden');
            }
            if (state.capital
